name: Onboarding Service Pipeline üöÄ

on:
  push:
    branches: [ "main" ]
    paths:
      - 'onboarding_service/**'
      - '.github/workflows/onboarding-service.yml'
  pull_request:
    paths:
      - 'onboarding_service/**'

# PERMISOS PARA GCP (OIDC - Workload Identity Federation)
permissions:
  contents: read
  id-token: write

jobs:
  call-workflow:
    uses: ./.github/workflows/microservice-pipeline.yml
    with:
      service_name: onboarding-service
      directory: onboarding_service
      sonar_project_key: quhealthy-onboarding-service

      # ‚úÖ CR√çTICO: Asignar la Service Account con permisos espec√≠ficos
      # Esto permite leer Secret Manager, subir a Storage y publicar en Pub/Sub.
      # Sin esto, usa la cuenta default que no tiene acceso a nada y falla el arranque.
      flags: '--service-account=sa-onboarding@quhealthy-backend.iam.gserviceaccount.com'

      # üëá MAPEO DE SECRETOS (Environment Variables -> GCP Secret Manager)
      # Nota: Aseg√∫rate de que los nombres a la IZQUIERDA coincidan con tu application.yml
      # y los de la DERECHA con los nombres en GCP Secret Manager.
      env_secrets_mapping: |
        DB_URL=application_db_url:latest
        DB_USER=application_db_user:latest
        DB_PASSWORD=application_db_password:latest
        JWT_SECRET_KEY=application_jwt_secret:latest
        GOOGLE_MAPS_API_KEY=application_google_maps_key:latest
        GEMINI_API_KEY=google-ai-api-key:latest

    secrets:
      # Credenciales de infraestructura (GitHub Secrets)
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_SA_EMAIL: ${{ secrets.GCP_SA_EMAIL }}
      GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}