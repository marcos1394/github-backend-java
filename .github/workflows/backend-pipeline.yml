name: QuHealthy Enterprise Pipeline 游낀游

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [opened, synchronize, reopened]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: quhealthy-repo

jobs:
  # ========================================================================
  # JOB 1: CALIDAD Y SEGURIDAD (SonarCloud - Multi-Module)
  # ========================================================================
  sonar-analysis:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth_service, onboarding_service]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # Analizamos cada servicio por separado
      - name: Build and Analyze ${{ matrix.service }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }} 
        # Navegamos a la carpeta del servicio antes de ejecutar Maven
        run: |
          cd ${{ matrix.service }}
          mvn -B verify -e -Dsurefire.useFile=false \
          -DskipTests=true \
          org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
          -Dsonar.projectKey=marcos1394_github-backend-java \
          -Dsonar.organization=marcos1394 \
          -Dsonar.host.url=https://sonarcloud.io

  # ========================================================================
  # JOB 2: BUILD & DEPLOY (Matrix Strategy)
  # ========================================================================
  deploy:
    needs: sonar-analysis
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    strategy:
      fail-fast: false # Si falla uno, que el otro siga intentando
      matrix:
        include:
          # --- CONFIGURACI칍N AUTH SERVICE ---
          - service-name: auth-service
            directory: auth_service
            # Secretos: Auth necesita TODOS (Stripe, Twilio, Resend, DB, JWT)
            secrets-list: |
              DB_URL=application_db_url:latest
              DB_USER=application_db_user:latest
              DB_PASSWORD=application_db_password:latest
              JWT_SECRET=application_jwt_secret:latest
              STRIPE_API_KEY=application_stripe_key:latest
              RESEND_API_KEY=application_resend_key:latest
              TWILIO_SID=application_twilio_sid:latest
              TWILIO_TOKEN=application_twilio_token:latest
              TWILIO_PHONE_NUMBER=application_twilio_phone:latest
              RESEND_FROM_EMAIL=RESEND_FROM_EMAIL:latest
              GOOGLE_CLIENT_ID=application_google_client_id:latest
              GOOGLE_CLIENT_SECRET=application_google_client_secret:latest

          # --- CONFIGURACI칍N ONBOARDING SERVICE ---
          - service-name: onboarding-service
            directory: onboarding_service
            # Secretos: Onboarding es ligero, SOLO necesita DB y JWT
            secrets-list: |
              DB_URL=application_db_url:latest
              DB_USER=application_db_user:latest
              DB_PASSWORD=application_db_password:latest
              JWT_SECRET=application_jwt_secret:latest

    steps:
      - uses: actions/checkout@v4

      # 1. Autenticaci칩n Google Cloud
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: '${{ secrets.GCP_SA_EMAIL }}'

      # 2. Setup SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 3. Docker Auth
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 4. Build & Push (Din치mico seg칰n la matriz)
      - name: Build and Push ${{ matrix.service-name }}
        run: |
          IMAGE_URI=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ matrix.service-name }}:${{ github.sha }}
          
          # Entramos al directorio espec칤fico (auth_service u onboarding_service)
          cd ${{ matrix.directory }}
          
          # Construimos usando el Dockerfile de esa carpeta
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

      # 5. Deploy to Cloud Run (Din치mico)
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ matrix.service-name }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ matrix.service-name }}:${{ github.sha }}
          
          # Variables p칰blicas (Puertos distintos si fuera local, pero en Cloud Run el container escucha en 8080 internamente por defecto, aunque Spring corra en 8081, Cloud Run mapea el puerto autom치ticamente si se configura o Spring se adapta)
          # NOTA: Cloud Run inyecta la variable PORT=8080. Spring Boot usar치 ese puerto.
          env_vars: |
            SPRING_PROFILES_ACTIVE=prod
          
          # Secretos espec칤ficos definidos en la matriz
          secrets: ${{ matrix.secrets-list }}